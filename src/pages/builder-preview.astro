---
// src/pages/builder-preview.astro
// Minimal Builder.io preview page for Astro â€” no inline scripts, no rewrites.

const key = import.meta.env.PUBLIC_BUILDER_API_KEY;

const params = new URL(Astro.request.url).searchParams;

// Model name (defaults to "page")
const incomingModel = (params.get("model") || "").trim();
const model = incomingModel ? incomingModel : "page";

// Resolve the target URL from common param names; default "/"
let targetUrl = params.get("url") || params.get("urlPath") || params.get("path") || "/";
if (!targetUrl || /\{url\}/i.test(targetUrl)) targetUrl = "/";
try {
  const u = new URL(targetUrl, "http://preview.local");
  targetUrl = u.pathname + (u.search || "");
} catch {}
if (!targetUrl.startsWith("/")) targetUrl = "/" + targetUrl;
while (targetUrl.length > 1 && targetUrl.startsWith("//")) targetUrl = targetUrl.slice(1);

// Optional: explicit content to render (bypasses targeting)
const entry = (params.get("entry") || "").trim();

// Send BOTH attributes; your space responds to urlPath
const userAttributes = JSON.stringify({ url: targetUrl, urlPath: targetUrl });
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Builder Preview</title>
    <meta name="robots" content="noindex, nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <builder-component
      model={model}
      api-key={key}
      data-url={targetUrl}
      user-attributes={userAttributes}
      entry={entry}
      content-id={entry}
      preview
    ></builder-component>

    <!-- Builder web components -->
    <script src="https://cdn.builder.io/js/webcomponents"></script>
  </body>
</html>
